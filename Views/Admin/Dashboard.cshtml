@using BarberPro.Models.DTOs.Responses
@{
    ViewData["Title"] = "Panel de Administración";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var dashboard = ViewBag.Dashboard as AdminDashboardDto;
}

<div class="container mx-auto p-4 sm:p-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gold mb-1">Panel de Administración</h1>
        <p class="text-sm text-gray-400">Bienvenido, @ViewBag.Nombre</p>
    </div>
    
    <!-- Estadísticas Principales -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
            <div class="text-xs text-gray-500 mb-1">Total Barberos</div>
            <div class="text-2xl font-bold text-gold">@(dashboard?.TotalBarbers ?? 0)</div>
            <div class="text-xs text-gray-400 mt-1">@(dashboard?.ActiveBarbers ?? 0) activos</div>
        </div>
        
        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
            <div class="text-xs text-gray-500 mb-1">Total Citas</div>
            <div class="text-2xl font-bold text-gold">@(dashboard?.TotalAppointments ?? 0)</div>
            <div class="text-xs text-gray-400 mt-1">@(dashboard?.PendingAppointments ?? 0) pendientes</div>
        </div>
        
        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
            <div class="text-xs text-gray-500 mb-1">Ingresos Totales</div>
            <div class="text-2xl font-bold text-gold">$@((dashboard?.TotalRevenue ?? 0).ToString("N2"))</div>
            <div class="text-xs text-gray-400 mt-1">Todos los tiempos</div>
        </div>
        
        <div class="bg-base-200 rounded-lg p-4 border border-base-300">
            <div class="text-xs text-gray-500 mb-1">Estado Citas</div>
            <div class="text-lg font-semibold text-success">@(dashboard?.ConfirmedAppointments ?? 0)</div>
            <div class="text-xs text-gray-400 mt-1">Confirmadas</div>
        </div>
    </div>
    
    <!-- Resumen de Citas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
        <div class="bg-base-200 rounded-lg p-3 border border-base-300">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Pendientes</span>
                <span class="text-lg font-semibold text-warning">@(dashboard?.PendingAppointments ?? 0)</span>
            </div>
        </div>
        <div class="bg-base-200 rounded-lg p-3 border border-base-300">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Confirmadas</span>
                <span class="text-lg font-semibold text-success">@(dashboard?.ConfirmedAppointments ?? 0)</span>
            </div>
        </div>
        <div class="bg-base-200 rounded-lg p-3 border border-base-300">
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">Canceladas</span>
                <span class="text-lg font-semibold text-error">@(dashboard?.CancelledAppointments ?? 0)</span>
            </div>
        </div>
    </div>
    
    <!-- Lista de Barberos Recientes -->
    @if (dashboard?.RecentBarbers != null && dashboard.RecentBarbers.Any())
    {
        <div class="bg-base-100 rounded-lg border border-base-300 shadow-sm">
            <div class="p-4 border-b border-base-300">
                <h2 class="text-lg font-semibold">Barberos Registrados</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th class="text-xs">Nombre</th>
                            <th class="text-xs">Negocio</th>
                            <th class="text-xs text-center">Citas</th>
                            <th class="text-xs text-right">Ingresos</th>
                            <th class="text-xs text-center">Estado</th>
                            <th class="text-xs text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var barber in dashboard.RecentBarbers.Take(10))
                        {
                            <tr>
                                <td class="text-sm font-medium">@(string.IsNullOrWhiteSpace(barber.Name) ? "-" : barber.Name)</td>
                                <td class="text-xs text-gray-500">@(string.IsNullOrWhiteSpace(barber.BusinessName) ? "-" : barber.BusinessName)</td>
                                <td class="text-center text-sm">@barber.TotalAppointments</td>
                                <td class="text-right text-sm text-gold">$@barber.TotalRevenue.ToString("N2")</td>
                                <td class="text-center">
                                    @if (barber.IsActive)
                                    {
                                        <span class="badge badge-success badge-xs">Activo</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-error badge-xs">Inactivo</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="flex gap-1 justify-center">
                                        <button onclick="viewBarberDetails(@barber.Id, '@Html.Raw(barber.Name.Replace("'", "\\'"))')" 
                                                class="btn btn-xs btn-primary" 
                                                title="Ver Detalles">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </button>
                                        <button onclick="editBarber(@barber.Id, '@Html.Raw(barber.Name.Replace("'", "\\'"))', '@Html.Raw((barber.BusinessName ?? "").Replace("'", "\\'"))', '@Html.Raw(barber.Phone.Replace("'", "\\'"))')" 
                                                class="btn btn-xs btn-info" 
                                                title="Editar">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </button>
                                        <button onclick="toggleBarberStatus(@barber.Id, @barber.IsActive.ToString().ToLower())" 
                                                class="btn btn-xs @(barber.IsActive ? "btn-warning" : "btn-success")" 
                                                title="@(barber.IsActive ? "Desactivar" : "Activar")">
                                            @if (barber.IsActive)
                                            {
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                                </svg>
                                            }
                                            else
                                            {
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            }
                                        </button>
                                        <button onclick="confirmDeleteBarber(@barber.Id, '@barber.Name')" 
                                                class="btn btn-xs btn-error" 
                                                title="Eliminar">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="bg-base-200 rounded-lg p-6 text-center border border-base-300">
            <p class="text-gray-500 text-sm mb-4">No hay barberos registrados aún</p>
            <button onclick="document.getElementById('modalCrearBarbero').showModal()" class="btn btn-sm btn-gold">
                Crear Primer Barbero
            </button>
        </div>
    }
    
    <!-- Botón flotante para crear barbero -->
    <div class="fixed bottom-6 right-6">
        <button onclick="document.getElementById('modalCrearBarbero').showModal()" class="btn btn-circle btn-gold shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
        </button>
    </div>
    
    <!-- Modal para crear barbero -->
    <dialog id="modalCrearBarbero" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Crear Nuevo Barbero</h3>
            <form id="formCrearBarbero" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Email</span>
                    </label>
                    <input type="email" name="email" class="input input-bordered" required placeholder="barbero@example.com"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Contraseña</span>
                    </label>
                    <input type="password" name="password" class="input input-bordered" required placeholder="Mínimo 6 caracteres"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Nombre</span>
                    </label>
                    <input type="text" name="name" class="input input-bordered" required placeholder="Juan Pérez"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Nombre del Negocio (opcional)</span>
                    </label>
                    <input type="text" name="businessName" class="input input-bordered" placeholder="Barbería Central"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Teléfono</span>
                    </label>
                    <input type="tel" name="phone" class="input input-bordered" required placeholder="1234567890"/>
                </div>
                <div class="modal-action">
                    <button type="button" onclick="document.getElementById('modalCrearBarbero').close()" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-gold">Crear Barbero</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    <!-- Modal para ver detalles del barbero -->
    <dialog id="modalVerBarbero" class="modal">
        <div class="modal-box w-11/12 max-w-7xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-2xl mb-6 text-gold" id="barberDetailsTitle">Detalles del Barbero</h3>
            
            <!-- Loading -->
            <div id="barberDetailsLoading" class="text-center py-12">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-4 text-gray-500">Cargando información...</p>
            </div>
            
            <!-- Contenido -->
            <div id="barberDetailsContent" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna Izquierda: Información del Barbero -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Información del Barbero -->
                        <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                            <h4 class="font-bold text-lg mb-4 text-gold border-b border-base-300 pb-2">Información del Barbero</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Nombre</label>
                                    <p class="font-semibold text-base mt-1" id="detailBarberName">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Email</label>
                                    <p class="font-medium text-sm mt-1 break-all" id="detailBarberEmail">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Negocio</label>
                                    <p class="font-medium text-base mt-1" id="detailBarberBusiness">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Teléfono</label>
                                    <p class="font-medium text-base mt-1" id="detailBarberPhone">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Slug</label>
                                    <p class="font-mono text-sm mt-1 text-gray-400" id="detailBarberSlug">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Estado</label>
                                    <p class="font-medium text-base mt-1" id="detailBarberStatus">-</p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase tracking-wide">Fecha de Registro</label>
                                    <p class="font-medium text-sm mt-1" id="detailBarberCreated">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Servicios -->
                        <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                            <h4 class="font-bold text-lg mb-4 text-gold border-b border-base-300 pb-2">Servicios</h4>
                            <div id="detailServices" class="space-y-2">
                                <p class="text-sm text-gray-500">Cargando servicios...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha: Estadísticas y Finanzas -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Estadísticas del Día -->
                        <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                            <h4 class="font-bold text-lg mb-4 text-gold border-b border-base-300 pb-2">Hoy</h4>
                            <div class="grid grid-cols-4 gap-4">
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Citas</div>
                                    <div class="text-2xl font-bold text-gold" id="detailTodayAppointments">0</div>
                                </div>
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Completadas</div>
                                    <div class="text-2xl font-bold text-success" id="detailTodayCompleted">0</div>
                                </div>
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Pendientes</div>
                                    <div class="text-2xl font-bold text-warning" id="detailTodayPending">0</div>
                                </div>
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Ingresos</div>
                                    <div class="text-2xl font-bold text-gold" id="detailTodayIncome">$0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estadísticas de la Semana y Mes -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Esta Semana -->
                            <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                                <h4 class="font-bold text-base mb-3 text-gold">Esta Semana</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Citas</div>
                                        <div class="text-xl font-bold text-gold" id="detailWeekAppointments">0</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Ingresos</div>
                                        <div class="text-xl font-bold text-success" id="detailWeekIncome">$0.00</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Egresos</div>
                                        <div class="text-xl font-bold text-error" id="detailWeekExpenses">$0.00</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Ganancia</div>
                                        <div class="text-xl font-bold text-gold" id="detailWeekProfit">$0.00</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Este Mes -->
                            <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                                <h4 class="font-bold text-base mb-3 text-gold">Este Mes</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Citas</div>
                                        <div class="text-xl font-bold text-gold" id="detailMonthAppointments">0</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Ingresos</div>
                                        <div class="text-xl font-bold text-success" id="detailMonthIncome">$0.00</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Egresos</div>
                                        <div class="text-xl font-bold text-error" id="detailMonthExpenses">$0.00</div>
                                    </div>
                                    <div class="bg-base-100 rounded-lg p-3 text-center border border-base-300">
                                        <div class="text-xs text-gray-500 mb-1">Ganancia</div>
                                        <div class="text-xl font-bold text-gold" id="detailMonthProfit">$0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen Financiero Total -->
                        <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                            <h4 class="font-bold text-lg mb-4 text-gold border-b border-base-300 pb-2">Resumen Financiero Total</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Ingresos Totales</div>
                                    <div class="text-2xl font-bold text-success" id="detailTotalIncome">$0.00</div>
                                </div>
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Egresos Totales</div>
                                    <div class="text-2xl font-bold text-error" id="detailTotalExpenses">$0.00</div>
                                </div>
                                <div class="bg-base-100 rounded-lg p-4 text-center border border-base-300">
                                    <div class="text-xs text-gray-500 mb-2">Ganancia Neta</div>
                                    <div class="text-2xl font-bold text-gold" id="detailNetProfit">$0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Citas Recientes y Próximas -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Citas Recientes -->
                            <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                                <h4 class="font-bold text-base mb-3 text-gold border-b border-base-300 pb-2">Citas Recientes</h4>
                                <div id="detailRecentAppointments" class="space-y-2">
                                    <p class="text-sm text-gray-500">Cargando citas...</p>
                                </div>
                            </div>
                            
                            <!-- Próximas Citas -->
                            <div class="bg-base-200 rounded-xl p-5 border border-base-300">
                                <h4 class="font-bold text-base mb-3 text-gold border-b border-base-300 pb-2">Próximas Citas</h4>
                                <div id="detailUpcomingAppointments" class="space-y-2">
                                    <p class="text-sm text-gray-500">Cargando citas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-action mt-6">
                <button onclick="document.getElementById('modalVerBarbero').close()" class="btn btn-gold">Cerrar</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    <!-- Modal para editar barbero -->
    <dialog id="modalEditarBarbero" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Editar Barbero</h3>
            <form id="formEditarBarbero" class="space-y-4">
                <input type="hidden" id="editBarberId" name="barberId"/>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Nombre</span>
                    </label>
                    <input type="text" id="editBarberName" name="name" class="input input-bordered" required placeholder="Juan Pérez"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Nombre del Negocio (opcional)</span>
                    </label>
                    <input type="text" id="editBarberBusinessName" name="businessName" class="input input-bordered" placeholder="Barbería Central"/>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Teléfono</span>
                    </label>
                    <input type="tel" id="editBarberPhone" name="phone" class="input input-bordered" required placeholder="1234567890"/>
                </div>
                <div class="modal-action">
                    <button type="button" onclick="document.getElementById('modalEditarBarbero').close()" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-gold">Guardar Cambios</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    <!-- Modal para confirmar eliminación -->
    <dialog id="modalEliminarBarbero" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Confirmar Eliminación</h3>
            <p class="mb-4">¿Estás seguro de que deseas eliminar al barbero <strong id="barberNameToDelete"></strong>?</p>
            <p class="text-sm text-warning mb-4">Esta acción no se puede deshacer.</p>
            <div class="modal-action">
                <button onclick="document.getElementById('modalEliminarBarbero').close()" class="btn btn-ghost">Cancelar</button>
                <button id="btnConfirmDelete" class="btn btn-error">Eliminar</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    <script>
        let barberIdToDelete = null;
        
        // Función para ver detalles del barbero
        async function viewBarberDetails(barberId, barberName) {
            document.getElementById('barberDetailsTitle').textContent = `Detalles: ${barberName}`;
            document.getElementById('barberDetailsLoading').classList.remove('hidden');
            document.getElementById('barberDetailsContent').classList.add('hidden');
            document.getElementById('modalVerBarbero').showModal();
            
            try {
                console.log('Cargando detalles del barbero:', barberId);
                
                // Obtener dashboard del barbero
                const dashboardResponse = await fetch(`/admin/barbers/${barberId}/dashboard`);
                console.log('Dashboard response status:', dashboardResponse.status);
                let dashboard = null;
                if (dashboardResponse.ok) {
                    dashboard = await dashboardResponse.json();
                    console.log('Dashboard data:', dashboard);
                } else {
                    const errorText = await dashboardResponse.text();
                    console.error('Error en dashboard:', errorText);
                }
                
                // Obtener resumen financiero
                const financeResponse = await fetch(`/admin/barbers/${barberId}/finances/summary`);
                console.log('Finance response status:', financeResponse.status);
                let finance = null;
                if (financeResponse.ok) {
                    finance = await financeResponse.json();
                    console.log('Finance data:', finance);
                } else {
                    const errorText = await financeResponse.text();
                    console.error('Error en finance:', errorText);
                }
                
                // Obtener servicios
                const servicesResponse = await fetch(`/admin/barbers/${barberId}/services`);
                console.log('Services response status:', servicesResponse.status);
                let services = [];
                if (servicesResponse.ok) {
                    services = await servicesResponse.json();
                    console.log('Services data:', services);
                } else {
                    const errorText = await servicesResponse.text();
                    console.error('Error en services:', errorText);
                }
                
                // Obtener citas
                const appointmentsResponse = await fetch(`/admin/barbers/${barberId}/appointments`);
                console.log('Appointments response status:', appointmentsResponse.status);
                let appointments = [];
                if (appointmentsResponse.ok) {
                    appointments = await appointmentsResponse.json();
                    console.log('Appointments data:', appointments);
                } else {
                    const errorText = await appointmentsResponse.text();
                    console.error('Error en appointments:', errorText);
                }
                
                // Llenar información del barbero
                if (dashboard && dashboard.barber) {
                    document.getElementById('detailBarberName').textContent = dashboard.barber.name || '-';
                    document.getElementById('detailBarberBusiness').textContent = dashboard.barber.businessName || '-';
                    document.getElementById('detailBarberPhone').textContent = dashboard.barber.phone || '-';
                    document.getElementById('detailBarberSlug').textContent = dashboard.barber.slug || '-';
                    if (dashboard.barber.email) {
                        const emailElement = document.getElementById('detailBarberEmail');
                        if (emailElement) {
                            emailElement.textContent = dashboard.barber.email;
                        }
                    }
                    document.getElementById('detailBarberStatus').innerHTML = dashboard.barber.isActive 
                        ? '<span class="badge badge-success badge-xs">Activo</span>' 
                        : '<span class="badge badge-error badge-xs">Inactivo</span>';
                    if (dashboard.barber.createdAt) {
                        const date = new Date(dashboard.barber.createdAt);
                        document.getElementById('detailBarberCreated').textContent = date.toLocaleDateString('es-ES');
                    }
                } else {
                    console.warn('No se recibió dashboard, intentando obtener información básica del barbero...');
                    // Si no hay dashboard, intentar obtener información básica del barbero desde la API
                    try {
                        const barberResponse = await fetch(`/api/admin/barbers/${barberId}`);
                        if (barberResponse.ok) {
                            const barber = await barberResponse.json();
                            document.getElementById('detailBarberName').textContent = barber.name || '-';
                            document.getElementById('detailBarberBusiness').textContent = barber.businessName || '-';
                            document.getElementById('detailBarberPhone').textContent = barber.phone || '-';
                            document.getElementById('detailBarberSlug').textContent = barber.slug || '-';
                            if (barber.email) {
                                const emailElement = document.getElementById('detailBarberEmail');
                                if (emailElement) {
                                    emailElement.textContent = barber.email;
                                }
                            }
                            document.getElementById('detailBarberStatus').innerHTML = barber.isActive 
                                ? '<span class="badge badge-success badge-xs">Activo</span>' 
                                : '<span class="badge badge-error badge-xs">Inactivo</span>';
                            if (barber.createdAt) {
                                const date = new Date(barber.createdAt);
                                document.getElementById('detailBarberCreated').textContent = date.toLocaleDateString('es-ES');
                            }
                        }
                    } catch (err) {
                        console.error('Error al obtener información básica del barbero:', err);
                    }
                }
                
                // Llenar estadísticas del día
                if (dashboard && dashboard.today) {
                    document.getElementById('detailTodayAppointments').textContent = dashboard.today.appointments || 0;
                    document.getElementById('detailTodayCompleted').textContent = dashboard.today.completed || 0;
                    document.getElementById('detailTodayPending').textContent = dashboard.today.pending || 0;
                    document.getElementById('detailTodayIncome').textContent = '$' + (dashboard.today.income || 0).toFixed(2);
                }
                
                // Llenar estadísticas de la semana
                if (dashboard && dashboard.thisWeek) {
                    document.getElementById('detailWeekAppointments').textContent = dashboard.thisWeek.appointments || 0;
                    document.getElementById('detailWeekIncome').textContent = '$' + (dashboard.thisWeek.income || 0).toFixed(2);
                    document.getElementById('detailWeekExpenses').textContent = '$' + (dashboard.thisWeek.expenses || 0).toFixed(2);
                    document.getElementById('detailWeekProfit').textContent = '$' + (dashboard.thisWeek.profit || 0).toFixed(2);
                }
                
                // Llenar estadísticas del mes
                if (dashboard && dashboard.thisMonth) {
                    document.getElementById('detailMonthAppointments').textContent = dashboard.thisMonth.appointments || 0;
                    document.getElementById('detailMonthIncome').textContent = '$' + (dashboard.thisMonth.income || 0).toFixed(2);
                    document.getElementById('detailMonthExpenses').textContent = '$' + (dashboard.thisMonth.expenses || 0).toFixed(2);
                    document.getElementById('detailMonthProfit').textContent = '$' + (dashboard.thisMonth.profit || 0).toFixed(2);
                }
                
                // Llenar resumen financiero total
                if (finance) {
                    document.getElementById('detailTotalIncome').textContent = '$' + (finance.totalIncome || 0).toFixed(2);
                    document.getElementById('detailTotalExpenses').textContent = '$' + (finance.totalExpenses || 0).toFixed(2);
                    document.getElementById('detailNetProfit').textContent = '$' + (finance.netProfit || 0).toFixed(2);
                }
                
                // Llenar servicios
                const servicesHtml = services.length > 0 
                    ? services.map(s => `
                        <div class="flex justify-between items-center p-3 bg-base-100 rounded-lg border border-base-300 mb-2">
                            <div>
                                <span class="font-medium text-sm">${s.name}</span>
                                <span class="text-xs text-gray-500 ml-2">${s.durationMinutes} min</span>
                            </div>
                            <span class="text-sm font-bold text-gold">$${s.price.toFixed(2)}</span>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-gray-500 text-center py-4">No hay servicios registrados</p>';
                document.getElementById('detailServices').innerHTML = servicesHtml;
                
                // Llenar citas recientes
                const formatAppointment = (a) => `
                    <div class="p-3 bg-base-100 rounded-lg border border-base-300 mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${a.clientName || 'Sin nombre'}</div>
                                <div class="text-xs text-gray-500 mt-1">${a.serviceName || 'Sin servicio'}</div>
                            </div>
                            <span class="badge badge-sm ${a.status === 'Completed' || a.status === 'Confirmed' ? 'badge-success' : a.status === 'Pending' ? 'badge-warning' : 'badge-info'}">${a.status || 'N/A'}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">${a.date || ''} ${a.time || ''}</div>
                    </div>
                `;
                
                if (dashboard && dashboard.recentAppointments && dashboard.recentAppointments.length > 0) {
                    const recentHtml = dashboard.recentAppointments.map(formatAppointment).join('');
                    document.getElementById('detailRecentAppointments').innerHTML = recentHtml;
                } else if (appointments && appointments.length > 0) {
                    // Usar citas obtenidas directamente si no hay en dashboard
                    const recentAppts = appointments.filter(a => {
                        const appDate = new Date(a.date);
                        const today = new Date();
                        return appDate < today;
                    }).slice(0, 5);
                    
                    const recentHtml = recentAppts.length > 0
                        ? recentAppts.map(formatAppointment).join('')
                        : '<p class="text-sm text-gray-500 text-center py-4">No hay citas recientes</p>';
                    document.getElementById('detailRecentAppointments').innerHTML = recentHtml;
                } else {
                    document.getElementById('detailRecentAppointments').innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay citas recientes</p>';
                }
                
                // Llenar próximas citas
                const formatUpcomingAppointment = (a) => `
                    <div class="p-3 bg-base-100 rounded-lg border border-base-300 mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${a.clientName || 'Sin nombre'}</div>
                                <div class="text-xs text-gray-500 mt-1">${a.serviceName || 'Sin servicio'}</div>
                            </div>
                            <span class="badge badge-sm ${a.status === 'Confirmed' ? 'badge-success' : 'badge-warning'}">${a.status || 'N/A'}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">${a.date || ''} ${a.time || ''}</div>
                    </div>
                `;
                
                if (dashboard && dashboard.upcomingAppointments && dashboard.upcomingAppointments.length > 0) {
                    const upcomingHtml = dashboard.upcomingAppointments.map(formatUpcomingAppointment).join('');
                    document.getElementById('detailUpcomingAppointments').innerHTML = upcomingHtml;
                } else if (appointments && appointments.length > 0) {
                    // Usar citas obtenidas directamente si no hay en dashboard
                    const upcomingAppts = appointments.filter(a => {
                        const appDate = new Date(a.date);
                        const today = new Date();
                        return appDate >= today;
                    }).slice(0, 5);
                    
                    const upcomingHtml = upcomingAppts.length > 0
                        ? upcomingAppts.map(formatUpcomingAppointment).join('')
                        : '<p class="text-sm text-gray-500 text-center py-4">No hay próximas citas</p>';
                    document.getElementById('detailUpcomingAppointments').innerHTML = upcomingHtml;
                } else {
                    document.getElementById('detailUpcomingAppointments').innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No hay próximas citas</p>';
                }
                
                // Mostrar contenido
                // Ocultar loading y mostrar contenido
                document.getElementById('barberDetailsLoading').classList.add('hidden');
                document.getElementById('barberDetailsContent').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error al cargar detalles:', error);
                document.getElementById('barberDetailsLoading').innerHTML = 
                    '<p class="text-error">Error al cargar la información del barbero: ' + error.message + '</p>';
            }
        }
        
        // Función para editar barbero
        function editBarber(id, name, businessName, phone) {
            document.getElementById('editBarberId').value = id;
            document.getElementById('editBarberName').value = name || '';
            document.getElementById('editBarberBusinessName').value = businessName || '';
            document.getElementById('editBarberPhone').value = phone || '';
            document.getElementById('modalEditarBarbero').showModal();
        }
        
        // Función para guardar cambios del barbero
        document.getElementById('formEditarBarbero').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const barberId = document.getElementById('editBarberId').value;
            
            const name = formData.get('name')?.toString().trim() || '';
            const businessName = formData.get('businessName')?.toString().trim() || null;
            const phone = formData.get('phone')?.toString().trim() || '';
            
            if (!name || !phone) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            const requestData = {
                name: name,
                businessName: businessName || null,
                phone: phone
            };
            
            console.log('Editando barbero:', barberId, requestData);
            
            try {
                // Intentar primero con PUT, si falla usar POST
                let response = await fetch(`/admin/barbers/${barberId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                // Si falla con 404, intentar con POST
                if (response.status === 404) {
                    response = await fetch(`/admin/barbers/${barberId}/update`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                }
                
                const result = await response.json();
                console.log('Respuesta del servidor:', result);
                
                if (result.success) {
                    alert('Barbero actualizado exitosamente');
                    document.getElementById('modalEditarBarbero').close();
                    e.target.reset();
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert('Error: ' + (result.message || 'No se pudo actualizar el barbero'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar barbero: ' + error.message);
            }
        });
        
        // Función para cambiar estado del barbero
        async function toggleBarberStatus(barberId, isActive) {
            if (!confirm(`¿Estás seguro de que deseas ${isActive ? 'desactivar' : 'activar'} este barbero?`)) {
                return;
            }
            
            try {
                // Intentar primero con PUT, si falla usar POST
                let response = await fetch(`/admin/barbers/${barberId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        isActive: !isActive
                    })
                });
                
                // Si falla con 404, intentar con POST
                if (response.status === 404) {
                    response = await fetch(`/admin/barbers/${barberId}/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isActive: !isActive
                        })
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Estado del barbero actualizado exitosamente');
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'No se pudo actualizar el estado'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar el estado: ' + error.message);
            }
        }
        
        // Función para confirmar eliminación
        function confirmDeleteBarber(barberId, barberName) {
            barberIdToDelete = barberId;
            document.getElementById('barberNameToDelete').textContent = barberName || 'este barbero';
            document.getElementById('modalEliminarBarbero').showModal();
        }
        
        // Función para eliminar barbero
        async function deleteBarber() {
            if (!barberIdToDelete) return;
            
            try {
                // Intentar primero con DELETE, si falla usar POST
                let response = await fetch(`/admin/barbers/${barberIdToDelete}`, {
                    method: 'DELETE'
                });
                
                // Si falla con 404, intentar con POST
                if (response.status === 404) {
                    response = await fetch(`/admin/barbers/${barberIdToDelete}/delete`, {
                        method: 'POST'
                    });
                }
                
                // Verificar si la respuesta tiene contenido
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // Si no hay contenido (204 No Content), crear resultado exitoso
                    if (response.ok || response.status === 204) {
                        result = { success: true, message: 'Barbero eliminado exitosamente' };
                    } else {
                        result = { success: false, message: 'Error al eliminar el barbero' };
                    }
                }
                
                if (result.success) {
                    alert('Barbero eliminado exitosamente');
                    document.getElementById('modalEliminarBarbero').close();
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'No se pudo eliminar el barbero'));
                }
            } catch (error) {
                console.error('Error:', error);
                // Si el error es por JSON vacío pero la respuesta fue exitosa
                if (error.message.includes('JSON') && error.message.includes('end')) {
                    alert('Barbero eliminado exitosamente');
                    document.getElementById('modalEliminarBarbero').close();
                    location.reload();
                } else {
                    alert('Error al eliminar barbero: ' + error.message);
                }
            }
        }
        
        // Asignar evento al botón de confirmar eliminación
        document.getElementById('btnConfirmDelete').addEventListener('click', deleteBarber);
        
        document.getElementById('formCrearBarbero').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // Obtener valores y validar
            const email = formData.get('email')?.toString().trim() || '';
            const password = formData.get('password')?.toString().trim() || '';
            const name = formData.get('name')?.toString().trim() || '';
            const businessName = formData.get('businessName')?.toString().trim() || null;
            const phone = formData.get('phone')?.toString().trim() || '';
            
            // Validar campos requeridos
            if (!email || !password || !name || !phone) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            const requestData = {
                email: email,
                password: password,
                name: name,
                businessName: businessName || null,
                phone: phone
            };
            
            console.log('Enviando datos:', requestData);
            
            try {
                const response = await fetch('/admin/createbarber', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                console.log('Respuesta del servidor:', result);
                
                if (result.success) {
                    alert('Barbero creado exitosamente: ' + (result.barber?.name || ''));
                    document.getElementById('modalCrearBarbero').close();
                    // Limpiar formulario
                    e.target.reset();
                    // Recargar página después de un breve delay
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert('Error: ' + (result.message || 'No se pudo crear el barbero'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear barbero: ' + error.message);
            }
        });
    </script>
</div>

