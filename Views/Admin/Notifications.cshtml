@using BarberNic.Models.Entities
@using BarberNic.Models.DTOs.Responses
@{
    ViewData["Title"] = "Enviar Notificaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var templates = ViewBag.Templates as List<Template> ?? new List<Template>();
    var barbers = ViewBag.Barbers as List<BarberDto> ?? new List<BarberDto>();
    var barbersWithUserId = ViewBag.BarbersWithUserId as dynamic ?? new List<dynamic>();
}

<div class="container mx-auto p-4 sm:p-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gold mb-1">Enviar Notificaciones Push</h1>
        <p class="text-sm text-gray-400">Gestiona y env√≠a notificaciones a todos los barberos</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Panel: Crear Plantilla -->
        <div class="bg-base-200 rounded-lg p-6 border border-base-300">
            <h2 class="text-xl font-bold mb-4 text-gold">Crear Nueva Plantilla</h2>
            
            <form id="createTemplateForm" class="space-y-4">
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Nombre de la Plantilla</span>
                    </label>
                    <input type="text" id="templateName" placeholder="Ej: Nueva actualizaci√≥n" 
                           class="input input-bordered w-full" />
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">T√≠tulo <span class="text-error">*</span></span>
                    </label>
                    <input type="text" id="templateTitle" placeholder="Ej: Nueva actualizaci√≥n disponible" 
                           class="input input-bordered w-full" required />
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Mensaje <span class="text-error">*</span></span>
                    </label>
                    <textarea id="templateBody" placeholder="Escribe el mensaje que recibir√°n los barberos..." 
                              class="textarea textarea-bordered w-full h-24" required></textarea>
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">URL de Imagen (Opcional)</span>
                    </label>
                    <input type="url" id="templateImageUrl" placeholder="https://ejemplo.com/imagen.jpg" 
                           class="input input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt text-gray-500">Debe ser una URL HTTPS v√°lida</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    <span class="text-lg">üíæ</span>
                    Guardar Plantilla
                </button>
            </form>
        </div>

        <!-- Panel: Enviar Notificaci√≥n -->
        <div class="bg-base-200 rounded-lg p-6 border border-base-300">
            <h2 class="text-xl font-bold mb-4 text-gold">Enviar Notificaci√≥n</h2>
            
            <form id="sendNotificationForm" class="space-y-4">
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Seleccionar Plantilla <span class="text-error">*</span></span>
                    </label>
                    <select id="selectedTemplate" class="select select-bordered w-full" required>
                        <option value="">-- Selecciona una plantilla --</option>
                        @foreach (var template in templates)
                        {
                            <option value="@template.Id" data-title="@template.Title" data-body="@template.Body" data-image="@(template.ImageUrl ?? "")">
                                @(template.Name ?? template.Title)
                            </option>
                        }
                    </select>
                    @if (!templates.Any())
                    {
                        <label class="label">
                            <span class="label-text-alt text-warning">No hay plantillas. Crea una primero.</span>
                        </label>
                    }
                </div>

                <!-- Vista Previa -->
                <div id="previewSection" class="hidden bg-base-300 rounded-lg p-4 border border-base-300">
                    <h3 class="font-semibold mb-2">Vista Previa:</h3>
                    <div class="bg-base-100 rounded p-3">
                        <div class="font-bold text-sm mb-1" id="previewTitle"></div>
                        <div class="text-sm text-gray-600" id="previewBody"></div>
                        <img id="previewImage" src="" alt="" class="mt-2 rounded max-w-full hidden" />
                    </div>
                </div>

                <!-- Selecci√≥n de Usuarios -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Destinatarios</span>
                    </label>
                    
                    <!-- Opci√≥n: Enviar a todos -->
                    <div class="form-control mb-4">
                        <label class="label cursor-pointer justify-start gap-3 p-4 rounded-xl bg-gradient-to-r from-primary/20 to-primary/10 border-2 border-primary/30 hover:border-primary transition-all duration-200 shadow-sm">
                            <input type="checkbox" id="sendToAll" class="checkbox checkbox-primary checkbox-lg" checked />
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">üåê</span>
                                    <span class="label-text font-bold text-lg text-primary">Enviar a todos los barberos</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 ml-8">Todos los barberos registrados recibir√°n la notificaci√≥n</div>
                            </div>
                            <div class="badge badge-primary badge-lg">Todos</div>
                        </label>
                    </div>

                    <!-- Selecci√≥n espec√≠fica de barberos -->
                    <div id="userSelectionContainer" class="hidden">
                        <div class="mb-3 flex items-center justify-between">
                            <span class="text-sm font-semibold text-gray-400">Selecciona barberos espec√≠ficos:</span>
                            <div class="flex gap-2">
                                <button type="button" onclick="selectAllBarbers()" class="btn btn-xs btn-ghost">Seleccionar todos</button>
                                <button type="button" onclick="deselectAllBarbers()" class="btn btn-xs btn-ghost">Deseleccionar</button>
                            </div>
                        </div>
                        
                        <div class="max-h-64 overflow-y-auto border border-base-300 rounded-xl p-3 bg-base-100 space-y-2 shadow-inner" id="barbersList">
                            @foreach (var barber in barbersWithUserId)
                            {
                                <label class="barber-card flex items-center gap-3 p-4 rounded-xl border-2 border-base-300 cursor-pointer hover:border-primary hover:bg-primary/5 hover:shadow-md transition-all duration-200 group" 
                                       data-user-id="@barber.UserId">
                                    <input type="checkbox" 
                                           class="barber-checkbox checkbox checkbox-primary checkbox-lg" 
                                           value="@barber.UserId" 
                                           onchange="updateSelectedCount()" />
                                    <div class="flex items-center gap-3 flex-1 min-w-0">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-primary-content rounded-full w-12 h-12">
                                                <span class="text-xl font-bold">@(barber.Name?.ToString().Substring(0, 1).ToUpper() ?? "B")</span>
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-semibold text-base truncate group-hover:text-primary transition-colors">@barber.Name</div>
                                            @if (!string.IsNullOrEmpty(barber.BusinessName?.ToString()))
                                            {
                                                <div class="text-xs text-gray-500 truncate flex items-center gap-1 mt-1">
                                                    <span>üè¢</span>
                                                    <span>@barber.BusinessName</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="badge badge-outline badge-lg">‚úÇÔ∏è Barbero</div>
                                </label>
                            }
                        </div>
                        
                        <div class="mt-3 p-3 rounded-lg bg-base-300 text-sm text-center">
                            <span id="selectedCount" class="font-semibold">0 barberos seleccionados</span>
                        </div>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="dataOnly" class="checkbox checkbox-primary" />
                        <span class="label-text">Solo datos (sin notificaci√≥n del sistema)</span>
                    </label>
                    <label class="label">
                        <span class="label-text-alt text-gray-500">√ötil para actualizaciones en segundo plano</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-success w-full" id="sendBtn" @(!templates.Any() ? "disabled" : "")>
                    <span class="text-lg">üì§</span>
                    <span id="sendButtonText">Enviar a Todos los Barberos</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Lista de Plantillas -->
    <div class="mt-6 bg-base-200 rounded-lg p-6 border border-base-300">
        <h2 class="text-xl font-bold mb-4 text-gold">Plantillas Guardadas</h2>
        
        @if (templates.Any())
        {
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>T√≠tulo</th>
                            <th>Mensaje</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var template in templates)
                        {
                            <tr>
                                <td class="font-semibold">@(template.Name ?? "Sin nombre")</td>
                                <td>@template.Title</td>
                                <td class="max-w-xs truncate">@template.Body</td>
                                <td>@template.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <button onclick="selectTemplate(@template.Id)" class="btn btn-sm btn-primary">
                                        Usar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <span>No hay plantillas guardadas. Crea una nueva plantilla arriba.</span>
            </div>
        }
    </div>
</div>

@section Styles {
    <style>
        .barber-card {
            transition: all 0.2s ease;
        }
        .barber-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .barber-card input[type="checkbox"]:checked ~ div {
            color: hsl(var(--p));
        }
        #barbersList::-webkit-scrollbar {
            width: 8px;
        }
        #barbersList::-webkit-scrollbar-track {
            background: hsl(var(--b2));
            border-radius: 4px;
        }
        #barbersList::-webkit-scrollbar-thumb {
            background: hsl(var(--p));
            border-radius: 4px;
        }
        #barbersList::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--pf));
        }
    </style>
}

@section Scripts {
    <script>
        // Vista previa de plantilla seleccionada
        document.getElementById('selectedTemplate').addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            if (this.value) {
                const previewSection = document.getElementById('previewSection');
                const previewTitle = document.getElementById('previewTitle');
                const previewBody = document.getElementById('previewBody');
                const previewImage = document.getElementById('previewImage');
                
                previewTitle.textContent = option.dataset.title;
                previewBody.textContent = option.dataset.body;
                
                if (option.dataset.image) {
                    previewImage.src = option.dataset.image;
                    previewImage.classList.remove('hidden');
                } else {
                    previewImage.classList.add('hidden');
                }
                
                previewSection.classList.remove('hidden');
            } else {
                document.getElementById('previewSection').classList.add('hidden');
            }
        });

        // Crear plantilla
        document.getElementById('createTemplateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner"></span> Guardando...';
            
            try {
                const response = await fetch('/admin/notifications/create-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: document.getElementById('templateName').value,
                        title: document.getElementById('templateTitle').value,
                        body: document.getElementById('templateBody').value,
                        imageUrl: document.getElementById('templateImageUrl').value || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Notify.success(result.message);
                    // Limpiar formulario
                    this.reset();
                    // Recargar p√°gina para mostrar nueva plantilla
                    setTimeout(() => location.reload(), 1000);
                } else {
                    Notify.error(result.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                Notify.error('Error al crear plantilla: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Toggle selecci√≥n de usuarios
        document.getElementById('sendToAll').addEventListener('change', function() {
            const userSelectionContainer = document.getElementById('userSelectionContainer');
            const sendButtonText = document.getElementById('sendButtonText');
            
            if (this.checked) {
                userSelectionContainer.classList.add('hidden');
                sendButtonText.textContent = 'Enviar a Todos los Barberos';
                // Deseleccionar todos los checkboxes
                document.querySelectorAll('.barber-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            } else {
                userSelectionContainer.classList.remove('hidden');
                sendButtonText.textContent = 'Enviar a Barberos Seleccionados';
            }
        });

        // Actualizar contador de seleccionados
        function updateSelectedCount() {
            const selected = document.querySelectorAll('.barber-checkbox:checked').length;
            const total = document.querySelectorAll('.barber-checkbox').length;
            const countElement = document.getElementById('selectedCount');
            
            if (selected === 0) {
                countElement.textContent = '0 barberos seleccionados';
                countElement.className = 'text-gray-400';
            } else if (selected === total) {
                countElement.textContent = `‚úì Todos los barberos seleccionados (${selected})`;
                countElement.className = 'text-success font-semibold';
            } else {
                countElement.textContent = `${selected} de ${total} barberos seleccionados`;
                countElement.className = 'text-primary font-semibold';
            }
        }

        // Seleccionar todos los barberos
        function selectAllBarbers() {
            document.querySelectorAll('.barber-checkbox').forEach(cb => {
                cb.checked = true;
                cb.closest('.barber-card').classList.add('border-primary', 'bg-primary/10');
            });
            updateSelectedCount();
        }

        // Deseleccionar todos los barberos
        function deselectAllBarbers() {
            document.querySelectorAll('.barber-checkbox').forEach(cb => {
                cb.checked = false;
                cb.closest('.barber-card').classList.remove('border-primary', 'bg-primary/10');
            });
            updateSelectedCount();
        }

        // Mejorar la interacci√≥n de las cards
        document.querySelectorAll('.barber-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // No toggle si se hace clic directamente en el checkbox
                if (e.target.type === 'checkbox') return;
                
                const checkbox = this.querySelector('.barber-checkbox');
                checkbox.checked = !checkbox.checked;
                
                if (checkbox.checked) {
                    this.classList.add('border-primary', 'bg-primary/10');
                } else {
                    this.classList.remove('border-primary', 'bg-primary/10');
                }
                
                updateSelectedCount();
            });
        });

        // Actualizar estilo visual cuando cambia el checkbox
        document.querySelectorAll('.barber-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.barber-card');
                if (this.checked) {
                    card.classList.add('border-primary', 'bg-primary/10');
                } else {
                    card.classList.remove('border-primary', 'bg-primary/10');
                }
            });
        });

        // Enviar notificaci√≥n
        document.getElementById('sendNotificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const templateId = document.getElementById('selectedTemplate').value;
            if (!templateId) {
                Notify.error('Selecciona una plantilla');
                return;
            }
            
            // Determinar destinatarios
            let userIds = null;
            const sendToAll = document.getElementById('sendToAll').checked;
            
            if (!sendToAll) {
                const selectedUsers = Array.from(document.querySelectorAll('.barber-checkbox:checked'))
                    .map(checkbox => parseInt(checkbox.value));
                
                if (selectedUsers.length === 0) {
                    Notify.error('Selecciona al menos un barbero o marca "Enviar a todos"');
                    return;
                }
                
                userIds = selectedUsers;
            }
            
            const btn = document.getElementById('sendBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading loading-spinner"></span> Enviando...';
            
            try {
                const requestBody = {
                    templateId: parseInt(templateId),
                    dataOnly: document.getElementById('dataOnly').checked,
                    extraData: null
                };
                
                if (userIds !== null) {
                    requestBody.userIds = userIds;
                }
                
                const response = await fetch('/admin/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Notify.success(result.message);
                    // Limpiar formulario
                    document.getElementById('selectedTemplate').value = '';
                    document.getElementById('previewSection').classList.add('hidden');
                    document.getElementById('dataOnly').checked = false;
                    document.getElementById('sendToAll').checked = true;
                    document.getElementById('userSelectionContainer').classList.add('hidden');
                    document.getElementById('sendButtonText').textContent = 'Enviar a Todos los Barberos';
                    // Deseleccionar todos los checkboxes
                    document.querySelectorAll('.barber-checkbox').forEach(cb => {
                        cb.checked = false;
                        cb.closest('.barber-card').classList.remove('border-primary', 'bg-primary/10');
                    });
                    updateSelectedCount();
                } else {
                    Notify.error(result.message);
                }
            } catch (error) {
                Notify.error('Error al enviar notificaci√≥n: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Seleccionar plantilla desde la tabla
        function selectTemplate(templateId) {
            document.getElementById('selectedTemplate').value = templateId;
            document.getElementById('selectedTemplate').dispatchEvent(new Event('change'));
            // Scroll al formulario de env√≠o
            document.getElementById('sendNotificationForm').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
}
