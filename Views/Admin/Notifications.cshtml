@using BarberNic.Models.Entities
@using BarberNic.Models.DTOs.Responses
@using System.Text.Json
@using System.Net
@{
    ViewData["Title"] = "Enviar Notificaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var templates = ViewBag.Templates as List<Template> ?? new List<Template>();
    var barbersWithUserId = ViewBag.BarbersWithUserId as dynamic ?? new List<dynamic>();
}

<div class="container mx-auto p-4 sm:p-6">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gold mb-1">Enviar Notificaciones Push</h1>
        <p class="text-sm text-gray-400">Gestiona y env√≠a notificaciones a todos los barberos</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Panel: Crear Plantilla -->
        <div class="bg-base-200 rounded-lg p-6 border border-base-300">
            <h2 class="text-xl font-bold mb-4 text-gold">Crear Nueva Plantilla</h2>
            
            <form id="createTemplateForm" class="space-y-4">
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Nombre de la Plantilla</span>
                    </label>
                    <input type="text" id="templateName" placeholder="Ej: Nueva actualizaci√≥n" 
                           class="input input-bordered w-full" />
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">T√≠tulo <span class="text-error">*</span></span>
                    </label>
                    <input type="text" id="templateTitle" placeholder="Ej: Nueva actualizaci√≥n disponible" 
                           class="input input-bordered w-full" required />
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Mensaje <span class="text-error">*</span></span>
                    </label>
                    <textarea id="templateBody" placeholder="Escribe el mensaje que recibir√°n los barberos..." 
                              class="textarea textarea-bordered w-full h-24" required></textarea>
                </div>

                <div>
                    <label class="label">
                        <span class="label-text font-semibold">URL de Imagen (Opcional)</span>
                    </label>
                    <input type="url" id="templateImageUrl" placeholder="https://ejemplo.com/imagen.jpg" 
                           class="input input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt text-gray-500">Debe ser una URL HTTPS v√°lida</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    <span class="text-lg">üíæ</span>
                    Guardar Plantilla
                </button>
            </form>
        </div>

        <!-- Panel: Enviar Notificaci√≥n -->
        <div class="bg-base-200 rounded-lg p-6 border border-base-300">
            <h2 class="text-xl font-bold mb-4 text-gold">Enviar Notificaci√≥n</h2>
            
            <form id="sendNotificationForm" class="space-y-4">
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Seleccionar Plantilla <span class="text-error">*</span></span>
                    </label>
                    <select id="selectedTemplate" class="select select-bordered w-full" required>
                        <option value="">-- Selecciona una plantilla --</option>
                        @foreach (var template in templates)
                        {
                            <option value="@template.Id" data-title="@template.Title" data-body="@template.Body" data-image="@(template.ImageUrl ?? "")">
                                @(template.Name ?? template.Title)
                            </option>
                        }
                    </select>
                    @if (!templates.Any())
                    {
                        <label class="label">
                            <span class="label-text-alt text-warning">No hay plantillas. Crea una primero.</span>
                        </label>
                    }
                </div>

                <!-- Vista Previa -->
                <div id="previewSection" class="hidden bg-base-300 rounded-lg p-4 border border-base-300">
                    <h3 class="font-semibold mb-2">Vista Previa:</h3>
                    <div class="bg-base-100 rounded p-3">
                        <div class="font-bold text-sm mb-1" id="previewTitle"></div>
                        <div class="text-sm text-gray-600" id="previewBody"></div>
                        <img id="previewImage" src="" alt="" class="mt-2 rounded max-w-full hidden" />
                    </div>
                </div>

                <!-- Selecci√≥n de Usuarios -->
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Destinatarios</span>
                    </label>
                    
                    <!-- Opci√≥n: Enviar a todos -->
                    <div class="form-control mb-3">
                        <label class="label cursor-pointer justify-start gap-2 p-2 rounded border border-base-300 hover:bg-base-300">
                            <input type="checkbox" id="sendToAll" class="checkbox checkbox-primary" />
                            <span class="label-text font-semibold">Seleccionar todos</span>
                        </label>
                    </div>

                    <!-- Selecci√≥n espec√≠fica de barberos - Tabla compacta -->
                    <div id="userSelectionContainer">
                        <div class="overflow-x-auto border border-base-300 rounded-lg">
                            <table class="table table-zebra table-compact w-full">
                                <thead>
                                    <tr>
                                        <th class="w-12">
                                            <input type="checkbox" 
                                                   class="checkbox checkbox-primary checkbox-sm" 
                                                   id="selectAllCheckbox"
                                                   onchange="toggleAllBarbers(this.checked)" />
                                        </th>
                                        <th>Nombre</th>
                                        <th>Negocio</th>
                                    </tr>
                                </thead>
                                <tbody id="barbersList">
                                    @if (barbersWithUserId != null && barbersWithUserId is IEnumerable<dynamic> && ((IEnumerable<dynamic>)barbersWithUserId).Any())
                                    {
                                        @foreach (var barber in barbersWithUserId)
                                        {
                                            <tr class="hover:bg-base-200 cursor-pointer barber-row" data-user-id="@barber.UserId">
                                                <td>
                                                    <input type="checkbox" 
                                                           class="barber-checkbox checkbox checkbox-primary checkbox-sm" 
                                                           value="@barber.UserId" 
                                                           onchange="updateSelectedCount()" />
                                                </td>
                                                <td class="font-medium">@barber.Name</td>
                                                <td class="text-sm text-gray-600">@(barber.BusinessName?.ToString() ?? "-")</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center py-4 text-gray-500">
                                                ‚ö†Ô∏è No hay barberos con dispositivos registrados
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-2 text-sm text-center text-gray-500">
                            <span id="selectedCount">0 barberos seleccionados</span>
                        </div>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="dataOnly" class="checkbox checkbox-primary" />
                        <span class="label-text">Solo datos (sin notificaci√≥n del sistema)</span>
                    </label>
                    <label class="label">
                        <span class="label-text-alt text-gray-500">√ötil para actualizaciones en segundo plano</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-success w-full" id="sendBtn" @(!templates.Any() ? "disabled" : "")>
                    <span class="text-lg">üì§</span>
                    <span id="sendButtonText">Enviar a Todos los Barberos</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Lista de Plantillas -->
    <div class="mt-6 bg-base-200 rounded-lg p-6 border border-base-300">
        <h2 class="text-xl font-bold mb-4 text-gold">Plantillas Guardadas</h2>
        
        @if (templates.Any())
        {
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>T√≠tulo</th>
                            <th>Mensaje</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var template in templates)
                        {
                            <tr>
                                <td class="font-semibold">@(template.Name ?? "Sin nombre")</td>
                                <td>@template.Title</td>
                                <td class="max-w-xs truncate">@template.Body</td>
                                <td>@template.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="selectTemplate(@template.Id)" class="btn btn-sm btn-primary">
                                            Usar
                                        </button>
                                        <button class="btn btn-sm btn-warning edit-template-btn" 
                                                data-template-id="@template.Id"
                                                data-template-name="@WebUtility.HtmlEncode(template.Name ?? "")"
                                                data-template-title="@WebUtility.HtmlEncode(template.Title)"
                                                data-template-body="@WebUtility.HtmlEncode(template.Body)"
                                                data-template-image="@WebUtility.HtmlEncode(template.ImageUrl ?? "")">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button class="btn btn-sm btn-error delete-template-btn" 
                                                data-template-id="@template.Id"
                                                data-template-title="@WebUtility.HtmlEncode(template.Title)">
                                            üóëÔ∏è Borrar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info">
                <span>No hay plantillas guardadas. Crea una nueva plantilla arriba.</span>
            </div>
        }
    </div>

    <!-- Modal para Editar Plantilla -->
    <dialog id="editTemplateModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4 text-gold">Editar Plantilla</h3>
            <form id="editTemplateForm" class="space-y-4">
                <input type="hidden" id="editTemplateId" />
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Nombre de la Plantilla</span>
                    </label>
                    <input type="text" id="editTemplateName" placeholder="Ej: Nueva actualizaci√≥n" 
                           class="input input-bordered w-full" />
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">T√≠tulo <span class="text-error">*</span></span>
                    </label>
                    <input type="text" id="editTemplateTitle" placeholder="Ej: Nueva actualizaci√≥n disponible" 
                           class="input input-bordered w-full" required />
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">Mensaje <span class="text-error">*</span></span>
                    </label>
                    <textarea id="editTemplateBody" placeholder="Escribe el mensaje que recibir√°n los barberos..." 
                              class="textarea textarea-bordered w-full h-24" required></textarea>
                </div>
                <div>
                    <label class="label">
                        <span class="label-text font-semibold">URL de Imagen (Opcional)</span>
                    </label>
                    <input type="url" id="editTemplateImageUrl" placeholder="https://ejemplo.com/imagen.jpg" 
                           class="input input-bordered w-full" />
                </div>
                <div class="modal-action">
                    <button type="button" onclick="closeEditModal()" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>

@section Styles {
    <style>
        .barber-row {
            transition: background-color 0.2s ease;
        }
        .barber-row:hover {
            background-color: hsl(var(--b2)) !important;
        }
        .table-compact {
            font-size: 0.875rem;
        }
        .table-compact td, .table-compact th {
            padding: 0.5rem;
        }
    </style>
}

@section Scripts {
    <script src="~/js/notificacion/notifications.js"></script>
}
