@using BarberPro.Models.DTOs.Responses
@{
    ViewData["Title"] = "Agendar Cita";
    Layout = null;
    var barber = ViewBag.Barber as BarberPublicDto;
    var slug = ViewBag.Slug as string;
}

<!DOCTYPE html>
<html lang="es" data-theme="business">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@(barber?.Name ?? "Barbero") - Agendar Cita</title>
    <script src="~/lib/tailwindcss/tailwind.min.js"></script>
    <link href="~/lib/daisyui/full.min.css" rel="stylesheet" type="text/css" />
    <style>
        .hero-pattern {
            background: linear-gradient(135deg, #f5f5f5 0%, #ffffff 50%, #fafafa 100%);
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(212, 175, 55, 0.03) 2px, rgba(212, 175, 55, 0.03) 4px),
                radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(184, 134, 11, 0.08) 0%, transparent 50%);
        }
        .text-gold {
            color: #d4af37;
        }
        .text-gold-light {
            color: #daa520;
        }
        .bg-gold {
            background-color: #d4af37;
        }
        .border-gold {
            border-color: #d4af37;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #daa520 100%);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #daa520 0%, #d4af37 50%, #b8860b 100%);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .barber-stripe {
            background: repeating-linear-gradient(
                90deg,
                #d4af37 0px,
                #d4af37 20px,
                #b8860b 20px,
                #b8860b 40px
            );
            height: 4px;
            width: 100%;
        }
        .card-glow {
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.15), 0 0 0 1px rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2), 0 0 15px rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }
        .barber-icon {
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.3));
        }
        @@keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(3deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .time-slot-btn {
            transition: all 0.3s ease;
        }
        .time-slot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }
        .time-slot-btn.selected {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: white;
            border-color: #d4af37;
        }
    </style>
</head>
<body class="min-h-screen hero-pattern">
    <!-- Header con dise√±o elegante -->
    <div class="bg-gradient-to-r from-white via-gray-50 to-white shadow-lg border-b-2 border-gold/30">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <!-- Icono de barbero -->
                    <div class="barber-icon">
                        <svg class="w-12 h-12 text-gold" viewBox="0 0 100 100" fill="currentColor">
                            <path d="M50 10 L30 85 L50 90 L70 85 Z" fill="currentColor" opacity="0.9"/>
                            <path d="M50 10 L45 30 L50 50 L55 30 Z" fill="currentColor" opacity="0.7"/>
                            <circle cx="50" cy="20" r="8" fill="white"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-black text-gray-800" style="font-family: 'Times New Roman', serif; letter-spacing: 0.05em;">
                            <span class="text-gold">@(barber?.Name ?? "Barbero")</span>
                        </h1>
                        @if (!string.IsNullOrEmpty(barber?.BusinessName))
                        {
                            <p class="text-gray-600 mt-1 font-medium">@barber.BusinessName</p>
                        }
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-gradient-to-r from-gold/10 to-gold/5 px-4 py-2 rounded-lg border border-gold/20">
                    <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    <span class="text-gray-700 font-semibold">@barber?.Phone</span>
                </div>
            </div>
        </div>
        <div class="barber-stripe"></div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Informaci√≥n -->
            <div class="lg:col-span-1 space-y-6 fade-in">
                <!-- Informaci√≥n del Barbero -->
                <div class="bg-white rounded-2xl p-6 shadow-xl card-glow">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gold/20 to-gold/10 border border-gold/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Informaci√≥n</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="pb-3 border-b border-gray-100">
                            <span class="text-sm text-gray-500 block mb-1">Nombre</span>
                            <p class="font-semibold text-gray-800">@barber?.Name</p>
                        </div>
                        @if (!string.IsNullOrEmpty(barber?.BusinessName))
                        {
                            <div class="pb-3 border-b border-gray-100">
                                <span class="text-sm text-gray-500 block mb-1">Negocio</span>
                                <p class="font-semibold text-gray-800">@barber.BusinessName</p>
                            </div>
                        }
                        <div>
                            <span class="text-sm text-gray-500 block mb-1">Tel√©fono</span>
                            <p class="font-semibold text-gray-800">@barber?.Phone</p>
                        </div>
                    </div>
                </div>

                <!-- Horarios de Trabajo -->
                <div class="bg-white rounded-2xl p-6 shadow-xl card-glow">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gold/20 to-gold/10 border border-gold/30 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Horarios</h2>
                    </div>
                    <div class="space-y-2">
                        @if (barber?.WorkingHours != null && barber.WorkingHours.Any(wh => wh.IsActive))
                        {
                            @foreach (var wh in barber.WorkingHours.Where(wh => wh.IsActive).OrderBy(w => w.DayOfWeek))
                            {
                                <div class="flex justify-between items-center py-2 px-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-700">@GetDayName(wh.DayOfWeek)</span>
                                    <span class="text-sm font-semibold text-gold">@wh.StartTime.ToString("HH:mm") - @wh.EndTime.ToString("HH:mm")</span>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-sm text-gray-500 text-center py-4">No hay horarios configurados</p>
                        }
                    </div>
                </div>

                <!-- Servicios Disponibles -->
                @if (barber?.Services != null && barber.Services.Any(s => s.IsActive))
                {
                    <div class="bg-white rounded-2xl p-6 shadow-xl card-glow">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gold/20 to-gold/10 border border-gold/30 flex items-center justify-center">
                                <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"/>
                                </svg>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800">Servicios</h2>
                        </div>
                        <div class="space-y-2">
                            @foreach (var service in barber.Services.Where(s => s.IsActive).Take(5))
                            {
                                <div class="flex justify-between items-center py-2 px-3 rounded-lg bg-gray-50">
                                    <span class="text-sm font-medium text-gray-700">@service.Name</span>
                                    <span class="text-sm font-bold text-gold">$@service.Price.ToString("N2")</span>
                                </div>
                            }
                            @if (barber.Services.Count(s => s.IsActive) > 5)
                            {
                                <p class="text-xs text-gray-500 text-center mt-2">Y m√°s servicios disponibles...</p>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Columna Derecha: Formulario de Agendamiento -->
            <div class="lg:col-span-2 fade-in">
                <div class="bg-white rounded-2xl p-8 shadow-xl card-glow">
                    <div class="mb-6">
                        <h2 class="text-3xl font-black text-gray-800 mb-2" style="font-family: 'Times New Roman', serif; letter-spacing: 0.05em;">
                            <span class="text-gold">AGENDAR</span> <span class="text-gray-800">CITA</span>
                        </h2>
                        <div class="barber-stripe mt-3"></div>
                        <p class="text-gray-600 mt-4">Completa el formulario para reservar tu cita</p>
                    </div>
                    
                    <form id="appointmentForm" class="space-y-6">
                        <!-- Servicios -->
                        <div>
                            <label class="label">
                                <span class="label-text font-bold text-gray-700 text-lg">Selecciona un Servicio <span class="text-sm font-normal text-gray-500">(Opcional)</span></span>
                            </label>
                            <select id="serviceSelect" name="serviceId" class="select select-bordered w-full bg-white border-gray-300 text-gray-800 input-glow focus:border-gold h-12 text-base">
                                <option value="">-- No especificar servicio (opcional) --</option>
                                @if (barber?.Services != null && barber.Services.Any())
                                {
                                    @foreach (var service in barber.Services.Where(s => s.IsActive))
                                    {
                                        <option value="@service.Id" data-price="@service.Price" data-duration="@service.DurationMinutes">
                                            @service.Name - $@service.Price.ToString("N2") (@service.DurationMinutes min)
                                        </option>
                                    }
                                }
                            </select>
                            @if (barber?.Services == null || !barber.Services.Any())
                            {
                                <div class="alert alert-info mt-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span>No hay servicios espec√≠ficos listados. Puedes agendar tu cita y el barbero te ayudar√° a decidir el servicio.</span>
                                </div>
                            }
                        </div>

                        <!-- Fecha -->
                        <div>
                            <label class="label">
                                <span class="label-text font-bold text-gray-700 text-lg">Fecha</span>
                            </label>
                            <input type="date" id="appointmentDate" name="date" class="input input-bordered w-full bg-white border-gray-300 text-gray-800 input-glow focus:border-gold h-12 text-base" required min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>

                        <!-- Hora -->
                        <div>
                            <label class="label">
                                <span class="label-text font-bold text-gray-700 text-lg">Hora Disponible</span>
                            </label>
                            <div id="timeSlots" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 min-h-[60px]">
                                <p class="text-sm text-gray-500 col-span-full text-center py-4">üìÖ Selecciona una fecha para ver horarios disponibles</p>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="divider my-8">
                            <span class="text-gold font-semibold">TUS DATOS</span>
                        </div>

                        <!-- Informaci√≥n del Cliente -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="label">
                                    <span class="label-text font-bold text-gray-700">Nombre Completo</span>
                                </label>
                                <input type="text" id="clientName" name="clientName" class="input input-bordered w-full bg-white border-gray-300 text-gray-800 input-glow focus:border-gold h-12" required placeholder="Tu nombre completo" />
                            </div>

                            <div>
                                <label class="label">
                                    <span class="label-text font-bold text-gray-700">Tel√©fono</span>
                                </label>
                                <input type="tel" id="clientPhone" name="clientPhone" class="input input-bordered w-full bg-white border-gray-300 text-gray-800 input-glow focus:border-gold h-12" required placeholder="Tu n√∫mero de tel√©fono" />
                            </div>
                        </div>

                        <!-- Bot√≥n de Env√≠o -->
                        <div class="pt-6">
                            <button type="submit" id="submitBtn" class="btn btn-gradient w-full text-lg font-bold h-14 text-white border-0 transition-all duration-300" disabled style="font-family: 'Times New Roman', serif; letter-spacing: 0.1em;">
                                <span id="submitText">AGENDAR CITA</span>
                                <span id="submitLoading" class="loading loading-spinner loading-sm hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de √âxito -->
    <dialog id="successModal" class="modal">
        <div class="modal-box bg-white">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="font-bold text-2xl text-gray-800">¬°Cita Agendada!</h3>
            </div>
            <p class="py-4 text-gray-600" id="successMessage">Tu cita ha sido agendada exitosamente. Te contactaremos pronto.</p>
            <div class="modal-action">
                <button onclick="document.getElementById('successModal').close()" class="btn btn-gradient text-white">Cerrar</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Modal de Error -->
    <dialog id="errorModal" class="modal">
        <div class="modal-box bg-white">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <h3 class="font-bold text-2xl text-gray-800">Error</h3>
            </div>
            <p class="py-4 text-gray-600" id="errorMessage">Ocurri√≥ un error al agendar la cita.</p>
            <div class="modal-action">
                <button onclick="document.getElementById('errorModal').close()" class="btn btn-gradient text-white">Cerrar</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        const slug = '@slug';
        let selectedDate = null;
        let selectedTime = null;

        // Cargar disponibilidad cuando se selecciona una fecha
        document.getElementById('appointmentDate').addEventListener('change', async function(e) {
            selectedDate = e.target.value;
            selectedTime = null;
            document.getElementById('submitBtn').disabled = true;
            
            if (!selectedDate) return;

            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '<div class="col-span-full text-center py-4"><span class="loading loading-spinner loading-md text-gold"></span><p class="text-sm text-gray-500 mt-2">Cargando horarios disponibles...</p></div>';

            try {
                const response = await fetch(`/b/${slug}/availability?date=${selectedDate}`);
                const data = await response.json();

                if (data.error) {
                    timeSlotsContainer.innerHTML = `<div class="alert alert-error col-span-full"><span>${data.error}</span></div>`;
                    return;
                }

                if (data.availableSlots && data.availableSlots.length > 0) {
                    const availableOnly = data.availableSlots.filter(slot => slot.isAvailable);
                    
                    if (availableOnly.length > 0) {
                        timeSlotsContainer.innerHTML = '';
                        availableOnly.forEach(slot => {
                            const timeStr = slot.startTime.substring(0, 5);
                            
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = 'btn btn-outline time-slot-btn border-gold text-gold hover:bg-gold hover:text-white hover:border-gold';
                            button.textContent = timeStr;
                            button.dataset.time = slot.startTime;
                            button.onclick = function() {
                                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                                    btn.classList.remove('selected', 'bg-gold', 'text-white');
                                    btn.classList.add('btn-outline', 'border-gold', 'text-gold');
                                });
                                this.classList.remove('btn-outline', 'border-gold', 'text-gold');
                                this.classList.add('selected', 'bg-gold', 'text-white');
                                selectedTime = this.dataset.time;
                                document.getElementById('submitBtn').disabled = false;
                            };
                            timeSlotsContainer.appendChild(button);
                        });
                    } else {
                        timeSlotsContainer.innerHTML = '<div class="alert alert-warning col-span-full"><span>‚ö†Ô∏è No hay horarios disponibles para esta fecha</span></div>';
                    }
                } else {
                    timeSlotsContainer.innerHTML = '<div class="alert alert-warning col-span-full"><span>‚ö†Ô∏è No hay horarios disponibles para esta fecha</span></div>';
                }
            } catch (error) {
                console.error('Error al cargar disponibilidad:', error);
                timeSlotsContainer.innerHTML = '<div class="alert alert-error col-span-full"><span>Error al cargar horarios disponibles</span></div>';
            }
        });

        // Manejar env√≠o del formulario
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serviceId = document.getElementById('serviceSelect').value;
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const date = document.getElementById('appointmentDate').value;

            // Validar campos requeridos (serviceId es opcional ahora)
            if (!clientName || !clientPhone || !date || !selectedTime) {
                showError('Por favor completa todos los campos requeridos');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            submitBtn.disabled = true;
            submitText.textContent = 'Agendando...';
            submitLoading.classList.remove('hidden');

            try {
                let timeOnly = selectedTime;
                if (!timeOnly.includes(':')) {
                    timeOnly = `${timeOnly}:00`;
                } else if (timeOnly.split(':').length === 2) {
                    timeOnly = `${timeOnly}:00`;
                }

                const response = await fetch(`/b/${slug}/appointment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barberSlug: slug,
                        serviceId: serviceId ? parseInt(serviceId) : null,
                        clientName: clientName,
                        clientPhone: clientPhone,
                        date: date,
                        time: timeOnly
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('successMessage').textContent = result.message || 'Tu cita ha sido agendada exitosamente. Te contactaremos pronto.';
                    document.getElementById('successModal').showModal();
                    document.getElementById('appointmentForm').reset();
                    document.getElementById('timeSlots').innerHTML = '<p class="text-sm text-gray-500 col-span-full text-center py-4">üìÖ Selecciona una fecha para ver horarios disponibles</p>';
                    selectedTime = null;
                    selectedDate = null;
                } else {
                    showError(result.message || 'Error al agendar la cita');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al agendar la cita. Por favor intenta nuevamente.');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'AGENDAR CITA';
                submitLoading.classList.add('hidden');
            }
        });

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').showModal();
        }

        // Deshabilitar fechas pasadas
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('appointmentDate').setAttribute('min', today);
    </script>
</body>
</html>

@functions {
    private string GetDayName(DayOfWeek dayOfWeek)
    {
        return dayOfWeek switch
        {
            DayOfWeek.Monday => "Lunes",
            DayOfWeek.Tuesday => "Martes",
            DayOfWeek.Wednesday => "Mi√©rcoles",
            DayOfWeek.Thursday => "Jueves",
            DayOfWeek.Friday => "Viernes",
            DayOfWeek.Saturday => "S√°bado",
            DayOfWeek.Sunday => "Domingo",
            _ => dayOfWeek.ToString()
        };
    }
}
